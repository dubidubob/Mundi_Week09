# 그림자 렌더링 시스템 구현 설명

## 1. Depth Buffer (깊이 버퍼)

그림자 렌더링의 핵심은 깊이 정보를 저장하는 Depth Buffer입니다.

### 구현 내용
- **Depth Map 생성**: 광원의 시점에서 씬을 렌더링하여 깊이 정보 저장
- **텍스처 포맷**: `DXGI_FORMAT_R24G8_TYPELESS` (24비트 깊이 + 8비트 스텐실)
- **셰이더**: `DepthOnly_VS.hlsl` - 깊이 정보만 기록하는 전용 버텍스 셰이더

```cpp
// LightManager.cpp - Depth Texture 생성
D3D11_TEXTURE2D_DESC TexDesc = {};
TexDesc.Format = DXGI_FORMAT_R24G8_TYPELESS;
TexDesc.BindFlags = D3D11_BIND_DEPTH_STENCIL | D3D11_BIND_SHADER_RESOURCE;
```

## 2. Shadow Bias (그림자 바이아스)

Shadow Acne(그림자 노이즈) 문제를 해결하기 위한 깊이 오프셋입니다.

### 구현된 Bias 종류

#### Constant Bias (상수 바이아스)
- 모든 픽셀에 동일한 고정 오프셋 적용
- `LightComponent.h`에 `ShadowBias` 속성으로 구현
- 범위: 0.0 ~ 100.0

#### Slope-Scaled Bias (경사 기반 바이아스)
- 표면의 기울기에 비례하여 바이아스 조정
- `LightComponent.h`에 `ShadowSlopeBias` 속성으로 구현
- 범위: 0.0 ~ 100.0

```cpp
// LightComponent.h
float ShadowBias = 0.0f;        // Constant Bias
float ShadowSlopeBias = 0.0f;   // Slope-Scaled Bias
```

### 셰이더에서의 적용
```hlsl
// LightingCommon.hlsl
float PixelDepth = ShadowTexCoord.z - 0.0025f;  // 고정 바이아스 적용
```

## 3. Cast Shadow (그림자 투사)

라이트별로 그림자 생성 여부를 제어하는 기능입니다.

### 구현 내용
- `LightComponentBase`에 `bCastShadows` 플래그
- 각 라이트 타입(Directional, Point, Spot)에서 지원
- 런타임에 동적으로 활성화/비활성화 가능

```cpp
// LightingCommon.hlsl
if (light.bCastShadows)
{
    float shadowFactor = CalculateSpotLightShadowFactor(...);
    diffuse *= shadowFactor;
    specular *= shadowFactor;
}
```

## 4. Cube Map (큐브맵 그림자)

Point Light의 전방향 그림자를 위한 큐브맵 구현입니다.

### 구현 내용
- **TextureCubeArray 사용**: 여러 Point Light를 하나의 배열로 관리
- **6개 면 렌더링**: 각 Point Light당 6방향(±X, ±Y, ±Z) 깊이 맵 생성
- **큐브맵 아틀라스**: 최대 8개의 Point Light 지원

```cpp
// LightManager.cpp - Cube Map Array 생성
CubeDesc.ArraySize = CubeArrayCount * 6;  // N개 라이트 × 6면
CubeDesc.MiscFlags = D3D11_RESOURCE_MISC_TEXTURECUBE;

// TextureCubeArray SRV 생성
srvDesc.ViewDimension = D3D11_SRV_DIMENSION_TEXTURECUBEARRAY;
srvDesc.TextureCubeArray.NumCubes = CubeArrayCount;
```

### 좌표 변환
```cpp
// PointLightComponent.cpp - 6개 면에 대한 View Matrix
LightViews[0] = FMatrix::LookAtLH(LightPosition, LightPosition + FVector(0, 1, 0), ...);  // +X
LightViews[1] = FMatrix::LookAtLH(LightPosition, LightPosition + FVector(0, -1, 0), ...); // -X
// ... 나머지 4개 면
```

## 5. PCF (Percentage Closer Filtering)

그림자 경계를 부드럽게 만드는 필터링 기법입니다.

### 구현 내용
- **Poisson Disk 샘플링**: 16개의 샘플 포인트 사용
- **적응형 필터 크기**: 텍셀 크기에 비례하여 필터 반경 조정
- **2D 및 CubeMap 오버로드**: Spot/Directional Light와 Point Light 모두 지원

```hlsl
// LightingCommon.hlsl - PCF 구현
float SampleShadowPCF(float PixelDepth, float2 AtlasUV, 
    int SampleCount, float2 FilterRadiusUV,
    Texture2D ShadowMap, SamplerComparisonState ShadowSampler)
{
    // Poisson Disk 패턴으로 여러 샘플 채취
    const float2 PoissonDisk[16] = { ... };
    
    for (int i = 0; i < SampleCount; i++)
    {
        float2 Offset = PoissonDisk[i] * FilterRadiusUV;
        ShadowFactorSum += ShadowMap.SampleCmpLevelZero(...);
    }
    
    return ShadowFactorSum / SampleCount;
}
```

### Spot Light PCF
- `SpotLightComponent`에 `SampleCount` 속성 (0~16)
- 0일 경우 PCF 비활성화

## 6. Cascaded Shadow Maps (캐스케이드 그림자 맵)

Directional Light의 넓은 영역을 효율적으로 커버하기 위한 기법입니다.

### 구현 내용
- **다중 해상도 분할**: 카메라 프러스텀을 여러 구간으로 분할
- **캐스케이드 개수**: 1~8개까지 설정 가능
- **Log-Linear 혼합**: 균등 분할과 로그 분할 사이의 가중치 조정

```cpp
// DirectionalLightComponent.cpp
int CascadedCount = 4;                      // 캐스케이드 개수
float CascadedLinearBlendingValue = 0.5f;   // Log~Linear 가중치
float CascadedOverlapValue = 0.1f;          // 확장 범위 크기

// 카메라 프러스텀을 CascadedCount개로 분할
CascadedSliceDepth = View->Camera->GetCascadedSliceDepth(
    CascadedCount, CascadedLinearBlendingValue);
```

### 캐스케이드 전환 블렌딩
```hlsl
// LightingCommon.hlsl
if (bNeedLerp)
{
    float PrevShadowFactor = SampleShadowPCF(..., PrevIdx, ...);
    float CurShadowFactor = SampleShadowPCF(..., CurIdx, ...);
    return lerp(PrevShadowFactor, CurShadowFactor, LerpValue);
}
```

### 디버그 시각화
- `CascadedAreaColorDebugValue`: 각 캐스케이드 영역을 색상으로 표시
- `CascadedAreaShadowDebugValue`: 특정 캐스케이드만 렌더링 (-1: 전체)

## 7. Shadow Atlas (그림자 아틀라스)

여러 라이트의 그림자 맵을 하나의 큰 텍스처에 통합 관리합니다.

### 2D Shadow Atlas
- **용도**: Directional Light, Spot Light
- **크기**: 16384×16384 픽셀
- **포맷**: `DXGI_FORMAT_R24G8_TYPELESS` (4바이트/픽셀)
- **메모리**: 약 1024MB (16384 × 16384 × 4 bytes = 1GB)

```cpp
// LightManager.h
uint32 ShadowAtlasSize2D = 16384;  // 2D 아틀라스 크기
ID3D11Texture2D* ShadowAtlasTexture2D;
ID3D11ShaderResourceView* ShadowAtlasSRV2D;
```

### Cube Map Atlas
- **용도**: Point Light
- **크기**: 1024×1024 픽셀 × 6면 × 8개
- **포맷**: `DXGI_FORMAT_R24G8_TYPELESS` (4바이트/픽셀)
- **메모리**: 약 48MB (1024 × 1024 × 6 × 8 × 4 bytes)

```cpp
// LightManager.h
uint32 AtlasSizeCube = 1024;      // 큐브맵 한 면의 해상도
uint32 CubeArrayCount = 8;        // 최대 Point Light 개수
ID3D11Texture2D* ShadowAtlasTextureCube;
```

### Atlas UV 변환
```hlsl
// LightingCommon.hlsl
float2 AtlasUV = ShadowTexCoord.xy;
AtlasUV.x = AtlasUV.x * ScaleOffset.x + ScaleOffset.z;
AtlasUV.y = AtlasUV.y * ScaleOffset.y + ScaleOffset.w;
```

## 8. 통계 및 모니터링

### Shadow Statistics
```cpp
// ShadowStats.h
struct FShadowStats
{
    uint32 TotalShadowCastingLights;
    uint32 ShadowAtlas2DSize;
    uint32 ShadowAtlasCubeSize;
    float TotalShadowMemoryMB;
};
```

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────┐
│          Scene Renderer (Pass 1)                │
│  ┌──────────────────────────────────────────┐   │
│  │  각 라이트별 그림자 맵 렌더링             │   │
│  │  - Directional: Cascaded Shadow Maps     │   │
│  │  - Spot: 1개 Depth Map                   │   │
│  │  - Point: 6개 Cube Map Faces             │   │
│  └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│          Shadow Atlas                           │
│  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 2D Atlas    │  │ Cube Map Array          │  │
│  │ 16384×16384 │  │ 1024×1024×6×8          │  │
│  │ (Dir, Spot) │  │ (Point Lights)          │  │
│  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│          Lighting Pass (Pass 2)                 │
│  - PCF Filtering                                │
│  - Shadow Factor 계산                           │
│  - Lighting 적용                                │
└─────────────────────────────────────────────────┘
```

## 주요 파일 구조

```
Mundi/
├── Shaders/
│   ├── Shadows/
│   │   └── DepthOnly_VS.hlsl          # 깊이 전용 버텍스 셰이더
│   └── Common/
│       └── LightingCommon.hlsl        # PCF, Shadow 계산
│
└── Source/Runtime/
    ├── Engine/Components/
    │   ├── LightComponent.h/cpp       # Bias 속성
    │   ├── DirectionalLightComponent  # Cascaded Shadow
    │   ├── PointLightComponent        # Cube Map Shadow
    │   └── SpotLightComponent         # PCF Sample Count
    │
    └── Renderer/
        ├── LightManager.h/cpp         # Shadow Atlas 관리
        └── ShadowStats.h              # 통계 시스템
```
